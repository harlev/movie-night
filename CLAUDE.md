# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Movie Night (FCMN) — a SvelteKit app for groups to suggest, discuss, and vote on movies using ranked-choice surveys. Deployed on Cloudflare Pages with D1 (serverless SQLite) as the database. Live at [fcmovienight.org](https://fcmovienight.org).

## Commands

```sh
npm run dev              # Start dev server (Vite)
npm run build            # Production build
npm run preview          # Preview with Cloudflare D1 bindings (requires build first)
npm run check            # TypeScript + Svelte type checking
npm run check:watch      # Type checking in watch mode
npm run db:generate      # Generate Drizzle migrations from schema changes
npm run db:migrate:local # Apply migrations to local D1
npm run db:migrate       # Apply migrations to production D1
npm run deploy           # Deploy to Cloudflare Pages (requires build first)
```

## Tech Stack

- **SvelteKit 2** (Svelte 5) with `@sveltejs/adapter-cloudflare`
- **Tailwind CSS v4** (via `@tailwindcss/vite` plugin)
- **Drizzle ORM** with SQLite dialect targeting Cloudflare D1
- **TypeScript** in strict mode, with `@cloudflare/workers-types`
- No runtime dependencies — everything runs on Cloudflare's edge

## Architecture

### Platform Bindings

Cloudflare bindings (DB, JWT_SECRET, TMDB_API_KEY, EMAIL_API_KEY) are accessed via `event.platform.env` in server-side code — not `process.env`. Local dev uses `.dev.vars` for these values (copy from `.dev.vars.example`).

### Database Access Pattern

Database is instantiated per-request: `const db = getDb(event.platform.env.DB)`. All query functions in `src/lib/server/db/queries/` take `db` as the first parameter. Schema is defined in `src/lib/server/db/schema.ts` — all IDs are text (generated via `generateId()` from `$lib/utils/id`), and timestamps are text columns storing ISO datetime strings.

### Authentication Flow

`hooks.server.ts` handles all auth: JWT verification, silent refresh token rotation, and route protection. The user object is set on `event.locals.user` and available to all server load functions. Route groups enforce access:
- `(auth)` — public routes (login, signup, bootstrap, password reset)
- `(app)` — requires authenticated user (layout server load checks `locals.user`)
- `(admin)` — requires admin role (layout server load checks `locals.user.role`)

### Route Groups & Layout Pattern

Each route group has a `+layout.server.ts` that gates access and passes `user` to child pages via `data.user`. Page data loading and form actions are in `+page.server.ts` files; UI is in `+page.svelte`.

### Styling

Dark theme with CSS custom properties defined in `src/app.css` (e.g., `--color-primary`, `--color-surface`, `--color-background`). Tailwind v4 is imported via `@import 'tailwindcss'` in `app.css`.

### API Endpoints

JSON API routes live under `src/routes/api/` — currently used for live survey polling (standings and ballot data). These check `locals.user` for auth.

### Key Conventions

- Server-only code lives under `$lib/server/` — auth, db, services (TMDB, email, scoring)
- Shared UI components in `$lib/components/ui/` with barrel export via `index.ts`
- Always check `platform?.env.DB` before database access in server handlers
- Drizzle migrations go in `drizzle/migrations/` (auto-generated by `drizzle-kit generate`)
